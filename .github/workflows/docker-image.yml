name: Build and Test Docker with Ngrok

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build Docker image
      id: build
      run: |
        # Build with simple tag
        docker build . --file Dockerfile --tag my-ngrok-image
        echo "‚úÖ Docker image built successfully"
    
    - name: Test Docker image
      run: |
        echo "üß™ Starting container test..."
        
        # Run container in background
        docker run -d --name ngrok-test-container my-ngrok-image
        
        # Wait for services to start
        echo "‚è≥ Waiting for ngrok to initialize (30 seconds)..."
        sleep 30
        
        # Check container status
        echo "=== CONTAINER STATUS ==="
        docker ps -a
        
        # Show ngrok logs
        echo "=== NGROK LOGS ==="
        docker logs ngrok-test-container --tail 50
        
        # Try to get tunnel information via API
        echo "=== ATTEMPTING TO GET TUNNEL INFO ==="
        docker exec ngrok-test-container curl -s http://localhost:4040/api/tunnels 2>/dev/null || echo "API not ready yet"
        
        # Show full logs if tunnel not found
        echo "=== FULL NGROK LOGS ==="
        docker logs ngrok-test-container
        
        # Cleanup
        echo "üßπ Cleaning up..."
        docker stop ngrok-test-container || true
        docker rm ngrok-test-container || true
        
        echo "‚úÖ Test completed"
    
    - name: Upload ngrok logs as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ngrok-logs
        path: |
          /tmp/ngrok-output.txt
        retention-days: 1

  manual-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build and run interactive test
      run: |
        docker build . --file Dockerfile --tag interactive-test
        echo "üéØ Starting interactive test - check GitHub Actions logs for ngrok URL"
        echo "‚è∞ This will run for 2 minutes to capture ngrok connection..."
        timeout 120s docker run --rm interactive-test || true
