name: Build and Test Docker with Ngrok

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build . --file Dockerfile --tag my-ngrok-image
        echo "âœ… Docker image built successfully"
    
    - name: Test Docker image and get ngrok URL
      run: |
        echo "ðŸ§ª Starting container test..."
        
        # Run container in background
        docker run -d --name ngrok-test my-ngrok-image
        
        # Wait for ngrok to start
        echo "â³ Waiting for ngrok to initialize (30 seconds)..."
        sleep 30
        
        # Check container status
        echo "=== CONTAINER STATUS ==="
        docker ps -a
        
        # Show ngrok logs
        echo "=== NGROK LOGS ==="
        docker logs ngrok-test
        
        # Check if token was configured
        echo "=== CHECKING TOKEN CONFIG ==="
        if docker logs ngrok-test | grep -q "Authtoken saved"; then
          echo "âœ… Token configured successfully"
        else
          echo "âŒ Token not configured"
        fi
        
        # Look for the ngrok URL
        echo "=== SEARCHING FOR NGROK URL ==="
        if docker logs ngrok-test | grep -q "started tunnel"; then
          echo "âœ… Tunnel started successfully!"
          docker logs ngrok-test | grep "started tunnel"
        elif docker logs ngrok-test | grep -q "tcp://"; then
          echo "âœ… Found ngrok URL!"
          docker logs ngrok-test | grep "tcp://"
        else
          echo "âŒ No tunnel URL found"
          docker logs ngrok-test | tail -20
        fi
        
        # Save logs
        docker logs ngrok-test > ngrok-output.txt
        
        # Cleanup
        docker stop ngrok-test || true
        docker rm ngrok-test || true
        
        echo "âœ… Test completed"
    
    - name: Upload ngrok logs
      uses: actions/upload-artifact@v4
      with:
        name: ngrok-logs
        path: ngrok-output.txt
        retention-days: 1
